<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Pendataan Member Komunitas X5</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            background-image: radial-gradient(at 80% 0%, hsla(218,100%,70%,0.3) 0px, transparent 50%),
                              radial-gradient(at 0% 100%, hsla(280,100%,80%,0.4) 0px, transparent 50%),
                              linear-gradient(to bottom right, #f0f2f5, #e0e7ed);
            background-repeat: no-repeat;
            background-attachment: fixed;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .main-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            width: 100%;
            max-width: 700px;
            padding: 0 10px;
            box-sizing: border-box;
            flex-grow: 1;
            justify-content: center;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            width: 100%;
            border: 1px solid rgba(224, 224, 224, 0.6);
            opacity: 1;
            transform: translateY(0) scale(1);
            transition: opacity 0.8s ease-out, transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .container.animate-initial-load {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
            animation: fadeInPopUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input[type="text"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #cfd8dc;
            border-radius: 12px;
            font-size: 1rem;
            color: #374151;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
            background-color: #f8fafd;
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.3);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 5px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            font-weight: 400;
            cursor: pointer;
        }
        .radio-group input[type="radio"] {
            width: auto;
            margin-right: 8px;
            accent-color: #6366f1;
            transform: scale(1.2);
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: white;
            letter-spacing: 0.5px;
        }
        .btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #6366f1;
            background-image: linear-gradient(to right, #6366f1, #8b5cf6);
            padding: 20px;
            font-size: 1.35rem;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.6);
        }
        .btn-primary:hover {
            background-color: #4f46e5;
            background-image: linear-gradient(to right, #4f46e5, #7c3aed);
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.7);
        }
        .btn-secondary {
            background-color: #6b7280;
            background-image: linear-gradient(to right, #6b7280, #9ca3af);
            box-shadow: 0 6px 15px rgba(107, 114, 128, 0.35);
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            background-image: linear-gradient(to right, #4b5563, #6b7280);
        }
        .btn-continue {
            background-color: #10b981;
            background-image: linear-gradient(to right, #10b981, #34d399);
            padding: 18px;
            font-size: 1.25rem;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.6);
            margin-top: 25px;
        }
        .btn-continue:hover {
            background-color: #059669;
            background-image: linear-gradient(to right, #059669, #22c55e);
        }
        .community-social-media-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #eceff1;
        }
        .hidden {
            display: none;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            pointer-events: none;
        }
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            max-width: 550px;
            width: 90%;
            text-align: center;
            transform: translateY(-100px) scale(0.8);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s ease-out;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s, transform 0.3s;
        }
        .modal-close-btn:hover {
            color: #6b7280;
            transform: rotate(180deg) scale(1.1);
        }
        .qr-code-container {
            margin-top: 20px;
            display: inline-block;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.4);
            border-left-color: #fff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes fadeInPopUp {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .animate-fade-in-slide-up {
            animation: fadeInPopUp 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .rules-section {
            max-height: 60vh; /* Adjusted height */
            overflow-y: auto;
            padding-right: 15px; /* For scrollbar */
            margin-bottom: 20px;
            line-height: 1.7;
            color: #4b5563;
            text-align: left;
        }
        .rules-section h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        .rules-section ol {
            list-style-position: inside; /* Fix for numbering */
            padding-left: 5px; /* Adjust padding */
        }
        .rules-section li {
            margin-bottom: 10px;
        }
        .agreement-checkbox-group {
            display: flex;
            align-items: flex-start;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        .agreement-checkbox-group input[type="checkbox"] {
            margin-top: 5px;
            margin-right: 12px;
            width: 20px;
            height: 20px;
            accent-color: #6366f1;
        }
        .agreement-checkbox-group label {
            font-weight: 500;
            cursor: pointer;
            color: #1f2937;
            text-align: left;
            flex: 1;
        }
        #faceDetectionContainer {
            text-align: center;
        }
        #webcamVideo {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background-color: #000;
            margin: 20px auto;
            display: block;
            border: 4px solid #cfd8dc;
            transition: border-color 0.5s ease-in-out;
        }
        #faceDetectionMessage {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #4b5563;
            font-weight: 500;
        }
        /* START: Scratch Card Styles */
        #scratchCardWrapper {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            height: 200px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #scratchCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 16px;
            cursor: grab;
            pointer-events: auto; 
        }
        #scratchCanvas:active {
            cursor: grabbing;
        }
        #hiddenContent {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            border-radius: 16px;
            padding: 20px;
        }
        #secretPassword {
            text-align: center;
            font-size: 1.2rem;
            padding: 12px;
        }
        #verifyPasswordButton {
            width: auto;
            padding: 10px 24px;
            font-size: 1rem;
            margin-top: 15px;
        }
        /* END: Scratch Card Styles */
        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            color: #6b7280;
            font-size: 0.9rem;
            border-top: 1px solid #e5e7eb;
            width: 100%;
            max-width: 700px;
        }
    </style>
</head>
<body>
    <div class="main-content-wrapper">
        <div class="container">
            <!-- Rules Section -->
            <div id="rulesContainer">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Peraturan Komunitas X5</h2>
                <div class="rules-section">
                    <p>Tujuan dibuat aturan yang sangat ketat untuk kepentingan bersama. Kami berkomitmen ingin menciptakan komunitas ini nyaman dan aman untuk siapa saja. Pastikan baca peraturan ini sebelum memulai diskusi.</p>
                    <h3>PERATURAN UMUM UNTUK SEMUA ANGGOTA</h3>
                    <ol class="list-decimal">
                        <li>Menjunjung tinggi etika, adab dan sopan santun kepada semua anggota.</li>
                        <li>Dilarang berdiskusi mendiskriminasi agama dan ras tertentu. Hindari juga berdiskusi sara, dan politik. [SP/BANNED]</li>
                        <li>Hindari melepas tittle ''X5'' tanpa persetujuan moderator/staff. [SP/BANNED]</li>
                        <li>Hindari sebisa mungkin mengirim gambar / video / audio berbau ponografi, obat obat an, dan kekerasan (jika terpaksa, silahkan blur bagian tersebut). [SP/BANNED]</li>
                        <li>Hindari memancing kerusuhan, kericuhan, keonaran yang mengatasnamakan XFIVE. [SP/BANNED]</li>
                        <li>Jika ada masalah sesama anggota harap konfirmasi moderator/admin biar lebih jelas perkaranya . jangan main out sendiri karna petinggi juga akan mengambil jalan keluarnya. [SP]</li>
                        <li>Dilarang membawa masalah personal ke dalam grup XFIVE. apabila melakukannya akan di beri peringatan dan jika terulang kembali kick out. [SP/BANNED]</li>
                        <li>Berpacaran sesama anggota boleh saja, asal jika ada masalah dengan hubungan kalian. Tolong jangan di campur adukkan ke community karena efeknya besar sekali terhadap anggota lain. [SP]</li>
                        <li>Diwajibkan menyapa sesama anggota XFIVE ( X5! )</li>
                        <li>Dilarang menggunakan program ilegal (cheat) disaat club battle / merugikan orang lain. [SP/BANNED]</li>
                        <li>Khusus member yang sudah bergabung divisi club, Dilarang meganti ke com. [SP]</li>
                        <li>Dilarang chatting antar member yang belum dikenal dan membuat risih kepada sesama member grup [SP/BANNED]</li>
                        <li>Menaati pada peraturan komunitas Ayodance (<a href="http://ayodance.megaxus.com/v1/page/rules" target="_blank" class="text-blue-600 hover:underline">http://ayodance.megaxus.com/v1/page/rules</a>)</li>
                    </ol>
                    <h3>KEBIJAKAN PRIVASI</h3>
                    <p>Kebijakan Privasi ini adalah komitmen dari XFIVE untuk menghargai dan melindungi setiap data atau informasi pribadi. Kebijakan Privasi ini menetapkan dasar atas perolehan, pengumpulan, pengolahan, dan atau segala bentuk pengelolaan yang terkait.</p>
                    <p>Member menyatakan bahwa setiap data Member merupakan data yang benar dan sah,serta Member memberikan persetujuan kepada XFIVE untuk memperoleh, mengumpulkan, menyimpan, mengelola dan mempergunakan data tersebut sebagaimana tercantum dalam Kebijakan Privasi.</p>
                </div>
                <div class="agreement-checkbox-group">
                    <input type="checkbox" id="agreeToRules">
                    <label for="agreeToRules">Saya menyetujui semua syarat, ketentuan, dan kebijakan privasi yang berlaku.</label>
                </div>
                <button type="button" id="continueButton" class="btn btn-continue" disabled>Lanjutkan</button>
            </div>

            <!-- Face Detection Section -->
            <div id="faceDetectionContainer" class="hidden animate-fade-in-slide-up">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Pendeteksi Wajah</h2>
                <p class="text-center text-gray-600 mb-4">Untuk verifikasi, kami perlu akses kamera Anda. Tidak ada data wajah yang disimpan.</p>
                <video id="webcamVideo" autoplay muted playsinline></video>
                <p id="faceDetectionMessage" class="text-center">Menunggu akses kamera...</p>
                <button type="button" id="startWebcamButton" class="btn btn-primary mt-4" style="background-image: linear-gradient(to right, #3b82f6, #2563eb);">Mulai Deteksi</button>
                <button type="button" id="continueToFormButton" class="btn btn-continue mt-4" disabled>Lanjutkan ke Verifikasi Final</button>
            </div>

            <!-- Scratch Card Verification Section -->
            <div id="scratchCardContainer" class="hidden animate-fade-in-slide-up">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Verifikasi Final!</h2>
                <p class="text-gray-600 mb-6 text-center">Gosok area di bawah ini untuk mengungkapkan tantangan terakhir!</p>
                <div id="scratchCardWrapper">
                    <canvas id="scratchCanvas"></canvas>
                    <div id="hiddenContent">
                        <label for="secretPassword" class="font-semibold text-gray-700 mb-2">Kata Sandi Komunitas:</label>
                        <input type="text" id="secretPassword" placeholder="Masukkan kata sandi...">
                        <button type="button" id="verifyPasswordButton" class="btn btn-primary">Verifikasi</button>
                        <p id="passwordError" class="text-red-500 text-sm mt-1 hidden">Kata sandi salah!</p>
                    </div>
                </div>
            </div>

            <!-- Member Registration Form -->
            <div id="memberFormContainer" class="hidden">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Formulir Pendataan Member</h1>
                <form id="memberForm">
                    <!-- Form fields here -->
                    <div class="form-group">
                        <label for="namaPanggilan">Nama Panggilan:</label>
                        <input type="text" id="namaPanggilan" name="namaPanggilan" required>
                    </div>
                    <div class="form-group">
                        <label for="nicknameAyodance">Nickname Ayodance:</label>
                        <input type="text" id="nicknameAyodance" name="nicknameAyodance" required>
                    </div>
                    <div class="form-group">
                        <label for="tanggalLahir">Tanggal Lahir:</label>
                        <input type="date" id="tanggalLahir" name="tanggalLahir" required>
                    </div>
                    <div class="form-group">
                        <label for="domisili">Domisili (Contoh: Jawa Barat - Bogor):</label>
                        <input type="text" id="domisili" name="domisili" required>
                    </div>
                    <div class="form-group">
                        <label>Punya Sosial Media?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="hasSocialMedia" value="Ya"> Ya</label>
                            <label><input type="radio" name="hasSocialMedia" value="Tidak" checked> Tidak</label>
                        </div>
                        <div id="socialMediaInputContainer" class="mt-3 hidden">
                            <label for="sosialMediaName">Nama Sosial Media (contoh: IG @username):</label>
                            <input type="text" id="sosialMediaName" name="sosialMediaName">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="divisiCommunity">Divisi Community:</label>
                        <select id="divisiCommunity" name="divisiCommunity" required>
                            <option value="">Pilih Divisi</option>
                            <option value="Club">Club</option>
                            <option value="Com">Com</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tester">Pilih Tester Anda:</label>
                        <select id="tester" name="tester" required>
                            <option value="">Pilih Tester</option>
                            <option value="Ramsky">Ramsky</option>
                            <option value="Fadel">Fadel</option>
                            <option value="Fajar">Fajar</option>
                            <option value="Thomas">Thomas</option>
                            <option value="Joko">Joko</option>
                            <option value="Citra">Citra</option>
                            <option value="Mey">Mey</option>
                            <option value="Vandhu">Vandhu</option>
                            <option value="Ardiansyah">Ardiansyah</option>
                            <option value="Eza">Eza</option>
                            <option value="Wale">Wale</option>
                            <option value="Zarah">Zarah</option>
                        </select>
                    </div>
                    <button type="submit" id="submitButton" class="btn btn-primary">
                        <span id="buttonText">Kirim Data</span>
                        <span id="loadingSpinner" class="loading-spinner hidden"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Notification -- UPDATED STRUCTURE -->
    <div id="notificationModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button id="modalCloseBtn" class="modal-close-btn">&times;</button>
            <h3 id="modalTitle" class="text-2xl font-bold mb-4"></h3>
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            
            <div id="modalQrCodeContainer" class="qr-code-container"></div>

            <!-- Button Container -->
            <div class="mt-5 flex flex-col sm:flex-row gap-4 justify-center">
                <a id="downloadQrButton" class="btn btn-primary hidden" style="width:auto; padding: 10px 20px;" download="qr-code-x5.png">Download QR</a>
                <button id="modalResetFormButton" class="btn btn-secondary">Isi Formulir Lagi</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2017-2025 XFIVECommunity. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Element Selectors ---
        const rulesContainer = document.getElementById('rulesContainer');
        const faceDetectionContainer = document.getElementById('faceDetectionContainer');
        const scratchCardContainer = document.getElementById('scratchCardContainer');
        const memberFormContainer = document.getElementById('memberFormContainer');
        const agreeToRulesCheckbox = document.getElementById('agreeToRules');
        const continueButton = document.getElementById('continueButton');
        const webcamVideo = document.getElementById('webcamVideo');
        const faceDetectionMessage = document.getElementById('faceDetectionMessage');
        const startWebcamButton = document.getElementById('startWebcamButton');
        const continueToFormButton = document.getElementById('continueToFormButton');
        const scratchCanvas = document.getElementById('scratchCanvas');
        const scratchCardWrapper = document.getElementById('scratchCardWrapper');
        const verifyPasswordButton = document.getElementById('verifyPasswordButton');
        const passwordInput = document.getElementById('secretPassword');
        const passwordError = document.getElementById('passwordError');
        const memberForm = document.getElementById('memberForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const socialMediaYes = document.querySelector('input[name="hasSocialMedia"][value="Ya"]');
        const socialMediaNo = document.querySelector('input[name="hasSocialMedia"][value="Tidak"]');
        const socialMediaInputContainer = document.getElementById('socialMediaInputContainer');
        const sosialMediaNameInput = document.getElementById('sosialMediaName');
        
        // Modal elements
        const notificationModalOverlay = document.getElementById('notificationModalOverlay');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalQrCodeContainer = document.getElementById('modalQrCodeContainer');
        const downloadQrButton = document.getElementById('downloadQrButton');
        const modalResetFormButton = document.getElementById('modalResetFormButton');

        // --- State and Data ---
        let mediaStream = null;
        let faceDetectionTimeoutId = null;
        let currentMemberName = '';
        const testerQrData = {
            "Ramsky": "https://wa.me/6285693393707", "Fadel": "https://wa.me/6282173876492",
            "Fajar": "https://wa.me/6287750639436", "Thomas": "https://wa.me/6281374402822",
            "Joko": "https://wa.me/6289514915776", "Citra": "https://wa.me/6283825756494",
            "Mey": "https://wa.me/6287704534610", "Vandhu": "https://wa.me/6281371412119",
            "Ardiansyah": "https://wa.me/6287745673345", "Eza": "https://wa.me/6289517090040",
            "Wale": "https://wa.me/6282276260740", "Zarah": "https://wa.me/6281342620907"
        };
        const googleAppsScriptURL = 'https://script.google.com/macros/s/AKfycbwEUL4YkEYBfaIl1-T2jYueJorhn5SyS2q1YLpse5bhlleULPXIy3TjnwkputvVm156gg/exec';

        // --- Functions ---
        const setupCanvas = () => {
            if (!scratchCanvas) return;
            const ctx = scratchCanvas.getContext('2d');
            scratchCanvas.width = scratchCardWrapper.clientWidth;
            scratchCanvas.height = scratchCardWrapper.clientHeight;
            const gradient = ctx.createLinearGradient(0, 0, scratchCanvas.width, scratchCanvas.height);
            gradient.addColorStop(0, '#8b5cf6');
            gradient.addColorStop(1, '#6366f1');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, scratchCanvas.width, scratchCanvas.height);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = 'bold 24px "Inter", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('GOSOK DI SINI', scratchCanvas.width / 2, scratchCanvas.height / 2);
            ctx.globalCompositeOperation = 'destination-out';
            scratchCanvas.style.opacity = '1';
            scratchCanvas.style.pointerEvents = 'auto';
        };

        function showNotification(title, message, isError = false, qrValue = null) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            
            // Reset modal state
            modalQrCodeContainer.innerHTML = '';
            downloadQrButton.classList.add('hidden');

            if (!isError && qrValue) {
                // On success, show QR and download button
                const qrCanvas = document.createElement('canvas');
                modalQrCodeContainer.appendChild(qrCanvas);
                new QRious({
                    element: qrCanvas,
                    value: qrValue,
                    size: 200,
                    background: 'white',
                    foreground: '#6366f1'
                });
                
                downloadQrButton.href = qrCanvas.toDataURL('image/png');
                downloadQrButton.download = `qr-code-x5-${currentMemberName.replace(/\s+/g, '-')}.png`;
                downloadQrButton.classList.remove('hidden');
            }
            notificationModalOverlay.classList.add('show');
        }

        function hideNotification() {
            notificationModalOverlay.classList.remove('show');
        }

        function resetToStart() {
            hideNotification();
            memberForm.reset();
            socialMediaInputContainer.classList.add('hidden');
            sosialMediaNameInput.required = false;
            memberFormContainer.classList.add('hidden');
            rulesContainer.classList.remove('hidden');
            agreeToRulesCheckbox.checked = false;
            continueButton.disabled = true;
            setupCanvas(); // Redraw scratch card
        }

        // --- Event Listeners ---
        // Step 1: Rules
        agreeToRulesCheckbox.addEventListener('change', () => { continueButton.disabled = !agreeToRulesCheckbox.checked; });
        continueButton.addEventListener('click', () => {
            if (agreeToRulesCheckbox.checked) {
                rulesContainer.classList.add('hidden');
                faceDetectionContainer.classList.remove('hidden');
            }
        });

        // Step 2: Face Detection
        startWebcamButton.addEventListener('click', async () => {
            startWebcamButton.disabled = true;
            faceDetectionMessage.textContent = 'Memulai kamera...';
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamVideo.srcObject = mediaStream;
                await webcamVideo.play();
                faceDetectionMessage.textContent = 'Kamera aktif. Mencari wajah...';
                webcamVideo.style.borderColor = '#f59e0b';
                faceDetectionTimeoutId = setTimeout(() => {
                    faceDetectionMessage.textContent = 'Wajah Terdeteksi!';
                    webcamVideo.style.borderColor = '#10b981';
                    continueToFormButton.disabled = false;
                }, 3000);
            } catch (err) {
                faceDetectionMessage.textContent = 'Gagal mengakses kamera. Pastikan izin diberikan.';
                webcamVideo.style.borderColor = '#ef4444';
                startWebcamButton.disabled = false;
            }
        });
        continueToFormButton.addEventListener('click', () => {
            if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
            faceDetectionContainer.classList.add('hidden');
            scratchCardContainer.classList.remove('hidden');
        });

        // Step 3: Scratch Card
        if (scratchCanvas) {
            const ctx = scratchCanvas.getContext('2d');
            let isScratching = false;
            const getScratchPosition = (e) => {
                const rect = scratchCanvas.getBoundingClientRect();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
            const scratch = (e) => {
                if (!isScratching) return;
                e.preventDefault();
                const pos = getScratchPosition(e);
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 30, 0, Math.PI * 2, false);
                ctx.fill();
            };
            const revealContent = () => {
                scratchCanvas.style.pointerEvents = 'none';
                scratchCanvas.style.transition = 'opacity 0.5s';
                scratchCanvas.style.opacity = '0';
            };
            const startScratch = (e) => { isScratching = true; scratch(e); };
            const endScratch = () => { if (!isScratching) return; isScratching = false; revealContent(); };
            window.addEventListener('resize', setupCanvas);
            scratchCanvas.addEventListener('mousedown', startScratch);
            scratchCanvas.addEventListener('mouseup', endScratch);
            scratchCanvas.addEventListener('mouseleave', endScratch);
            scratchCanvas.addEventListener('mousemove', scratch);
            scratchCanvas.addEventListener('touchstart', startScratch, { passive: false });
            scratchCanvas.addEventListener('touchend', endScratch);
            scratchCanvas.addEventListener('touchmove', scratch, { passive: false });
            setupCanvas();
        }
        verifyPasswordButton.addEventListener('click', () => {
            if (passwordInput.value.trim().toUpperCase() === 'X5') {
                passwordError.classList.add('hidden');
                scratchCardContainer.classList.add('hidden');
                memberFormContainer.classList.remove('hidden');
            } else {
                passwordError.classList.remove('hidden');
            }
        });

        // Step 4: Form Submission
        socialMediaYes.addEventListener('change', () => {
            socialMediaInputContainer.classList.remove('hidden');
            sosialMediaNameInput.required = true;
        });
        socialMediaNo.addEventListener('change', () => {
            socialMediaInputContainer.classList.add('hidden');
            sosialMediaNameInput.required = false;
        });
        memberForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            submitButton.disabled = true;
            buttonText.textContent = 'Mengirim...';
            loadingSpinner.classList.remove('hidden');

            const formData = new FormData(memberForm);
            const data = Object.fromEntries(formData.entries());
            data.type = 'registration';
            if (data.hasSocialMedia === 'Tidak') data.sosialMediaName = 'Tidak ada';
            currentMemberName = data.namaPanggilan; // Store name for download filename

            try {
                await fetch(googleAppsScriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const testerName = data.tester;
                const qrValue = testerQrData[testerName] || `Selamat datang di X5, ${data.namaPanggilan}!`;
                const successMessage = `Terima kasih, <strong>${data.namaPanggilan}</strong>! Data Anda berhasil dikirim. Silakan scan QR ini untuk menghubungi tester kalian.`;
                
                showNotification('Pendaftaran Berhasil!', successMessage, false, qrValue);
                memberFormContainer.classList.add('hidden');

            } catch (error) {
                console.error('Error submitting form:', error);
                showNotification('Terjadi Kesalahan', 'Maaf, data Anda gagal dikirim. Silakan coba lagi nanti.', true);
            } finally {
                submitButton.disabled = false;
                buttonText.textContent = 'Kirim Data';
                loadingSpinner.classList.add('hidden');
            }
        });

        // Modal Controls
        modalCloseBtn.addEventListener('click', hideNotification);
        modalResetFormButton.addEventListener('click', resetToStart);
        notificationModalOverlay.addEventListener('click', (e) => {
            if (e.target === notificationModalOverlay) hideNotification();
        });
    });
    </script>
</body>
</html>
